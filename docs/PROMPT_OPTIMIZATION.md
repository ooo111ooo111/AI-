# 提示词优化说明

## ✅ 优化完成

**优化时间**: 2025-12-05
**优化文件**: `backend/src/services/qwen.service.ts`

---

## 📋 优化内容

### 1. 提示词增强

**原提示词问题**:
- ❌ 操作建议笼统，缺乏可执行性
- ❌ 没有止损止盈具体价位
- ❌ 没有仓位管理建议
- ❌ 风险控制不足

**优化后改进**:
- ✅ 完整的交易计划框架
- ✅ 具体的止损止盈价位
- ✅ 详细的仓位配置建议
- ✅ 分批建仓/减仓策略
- ✅ 风险收益比计算
- ✅ 移动止盈策略

### 2. 新增要求内容

#### 📊 操作建议结构（recommendation 字段）

**【交易方向】**
- 看多/看空/观望
- 说明理由

**【入场策略】**
- 建议入场价位：$具体价格
- 入场时机：突破确认/回调企稳
- 仓位配置：总资金的 X%（根据风险等级）
  - 高风险：10-20%
  - 中风险：20-40%
  - 低风险：40-60%
- 分批建仓：2-3 批入场

**【止损策略】**
- 止损价位：$具体价格
- 止损理由：技术位失效说明
- 单笔最大亏损：1-3% 总资金

**【止盈策略】**
- 目标位 1：$具体价格（减仓 30-50%）
- 目标位 2：$具体价格（减仓 30-40%）
- 目标位 3：$具体价格（剩余仓位）
- 移动止盈：上移止损保护利润

**【风险提示】**
- 消息面影响
- 市场情绪
- 纪律执行

### 3. 分析深度提升

**indicators 字段**:
```json
{
  "rsi": "具体数值",
  "macd": "金叉/死叉/多头/空头，柱状图变化",
  "volume": "放量/缩量/价量配合情况",
  "movingAverages": "多头排列/空头排列/金叉/死叉"
}
```

**analysis 字段**（300 字以内）:
1. 当前趋势判断和理由
2. 关键价位分析
3. 技术指标综合判断
4. 潜在风险点和机会

### 4. 风险等级标准

**riskLevel 判断标准**:
- **high**: 技术形态不明确、指标背离、成交量异常、波动率大
- **medium**: 技术形态较清晰、指标基本一致、成交量正常
- **low**: 技术形态明确、多指标共振、趋势强劲、成交量确认

### 5. Token 限制调整

- **原限制**: 2048 tokens
- **新限制**: 3096 tokens
- **原因**: 更详细的分析和交易建议需要更多输出空间

---

## 📝 输出示例

### 优化前的 recommendation
```
建议等待回调至支撑位 3140 附近买入，目标看向 3193.15 阻力位。
```

### 优化后的 recommendation
```
【交易方向】看多，理由：技术形态呈现上涨趋势，均线多头排列，MACD金叉向上

【入场策略】
- 建议入场价位：$3140-3150（关键支撑区域回调企稳）
- 入场时机：等待价格回调至支撑位并出现止跌信号（如小时线收阳）
- 仓位配置：建议总资金的 30%（中等风险）
- 分批建仓：第一批 3150 建 15%，第二批 3140 加仓 15%

【止损策略】
- 止损价位：$3066（关键支撑位下方，约 2.5%）
- 止损理由：跌破 3066 说明上涨趋势失效，多头结构破坏
- 单笔最大亏损：不超过总资金的 2%

【止盈策略】
- 目标位 1：$3193（第一阻力位），建议减仓 50%，锁定部分利润
- 目标位 2：$3250（次级阻力位），建议减仓 30%
- 目标位 3：$3300（终极目标），剩余 20% 仓位
- 移动止盈：突破 3193 后，将止损位上移至 3150（成本价保护）

【风险提示】
- 关注美联储政策变动和宏观经济数据
- 注意比特币走势对整体加密货币市场的影响
- 严格执行止损，避免侥幸心理导致亏损扩大
```

---

## 🎯 使用方法

### 1. 重启后端服务（必须）
```bash
cd backend
npm run dev
```

### 2. 上传新图片测试
1. 打开前端：`http://localhost:5173`
2. 上传加密货币图表
3. 选择币种并开始分析
4. 查看"操作建议"部分

### 3. 验证输出内容

**检查 recommendation 字段**是否包含：
- ✅ 交易方向和理由
- ✅ 入场价位和仓位配置
- ✅ 止损价位和理由
- ✅ 分批止盈策略
- ✅ 风险提示

---

## 📊 对比分析

| 维度 | 优化前 | 优化后 |
|------|--------|--------|
| **可执行性** | 笼统建议 | 具体价位和仓位 |
| **风险控制** | 无止损策略 | 完整止损止盈计划 |
| **资金管理** | 未提及 | 明确仓位比例 |
| **操作细节** | 简单描述 | 分批建仓/减仓 |
| **响应长度** | ~500 字 | ~800-1000 字 |
| **专业程度** | 普通分析师 | 量化交易+风控专家 |

---

## ⚠️ 注意事项

### 1. 模型理解能力
- Qwen3-VL-Flash 可能不会完全按照格式输出
- 建议测试多张图表，观察输出质量
- 如果输出不符合预期，可能需要进一步简化提示词

### 2. Token 成本
- 更长的提示词会增加输入 token 成本
- 更详细的输出会增加输出 token 成本
- 预计每次分析成本增加约 30-40%

### 3. 响应时间
- 由于输出更长，响应时间可能增加 1-2 秒
- Qwen3-VL-Flash 仍然比 DeepSeek 快

### 4. 法律免责
确保在前端显眼位置添加免责声明：
```
⚠️ 本分析由 AI 生成，仅供参考，不构成投资建议。
加密货币投资风险极高，请谨慎决策，自行承担风险。
```

---

## 🔧 进一步优化建议

### 短期（1-2天）
1. 测试多个不同走势的图表
2. 收集实际输出，评估质量
3. 根据反馈微调提示词

### 中期（1周）
1. 添加风险收益比计算
2. 根据历史数据优化仓位比例建议
3. 支持用户自定义风险偏好

### 长期（1月）
1. 训练专门的交易策略模型
2. 整合历史回测数据
3. 提供策略胜率统计

---

## 📚 相关文件

- `backend/src/services/qwen.service.ts` - 提示词优化（已修改）
- `backend/src/models/Analysis.ts` - 数据模型（无需修改）
- `frontend/src/components/AnalysisResult.tsx` - 前端显示（无需修改）

---

## ✅ 优化确认清单

- [x] 提示词已优化
- [x] 增加止损止盈要求
- [x] 增加仓位管理要求
- [x] 增加风险控制要求
- [x] 调整 max_tokens 限制
- [x] 创建优化文档
- [ ] 重启后端服务
- [ ] 测试实际输出效果

---

**优化负责人**: Claude Code
**完成时间**: 2025-12-05
**影响范围**: AI 分析质量提升
**建议**: 立即重启后端测试效果
